{% extends 'vegetables/base.html' %}
{% load static %}

{% block title %}Thanh toán{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'vegetables:home' %}">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'vegetables:cart_detail' %}">Giỏ hàng</a></li>
            <li class="breadcrumb-item active">Thanh toán</li>
        </ol>
    </nav>
    
    <div class="row">
        <div class="col-lg-8">
            <h1 class="h2 mb-4">
                <i class="fas fa-credit-card"></i> Thông tin thanh toán
            </h1>
            
            <form method="post" id="checkout-form">
                {% csrf_token %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user"></i> Thông tin khách hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customer_name" class="form-label">Họ và tên *</label>
                                <input type="text" class="form-control" id="customer_name" name="customer_name" 
                                       required placeholder="Nhập họ và tên">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customer_phone" class="form-label">Số điện thoại *</label>
                                <input type="tel" class="form-control" id="customer_phone" name="customer_phone" 
                                       required placeholder="Nhập số điện thoại">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="customer_email" class="form-label">Email (không bắt buộc)</label>
                            <input type="email" class="form-control" id="customer_email" name="customer_email" 
                                   placeholder="Nhập email để nhận thông báo đơn hàng">
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Địa chỉ giao hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="delivery_address" class="form-label">Địa chỉ chi tiết *</label>
                            <textarea class="form-control" id="delivery_address" name="delivery_address" 
                                      rows="3" required placeholder="Nhập địa chỉ giao hàng đầy đủ (số nhà, đường, phường/xã, quận/huyện, tỉnh/thành phố)"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Ghi chú đơn hàng</label>
                            <textarea class="form-control" id="notes" name="notes" 
                                      rows="2" placeholder="Ghi chú thêm cho đơn hàng (thời gian giao hàng, yêu cầu đặc biệt...)"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-credit-card"></i> Phương thức thanh toán</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" checked>
                            <label class="form-check-label" for="cod">
                                <i class="fas fa-money-bill-wave"></i> Thanh toán khi nhận hàng (COD)
                            </label>
                            <small class="form-text text-muted d-block">Thanh toán bằng tiền mặt khi nhận hàng</small>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-check"></i> Đặt hàng
                    </button>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <!-- Order summary -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-receipt"></i> Đơn hàng của bạn</h5>
                </div>
                <div class="card-body">
                    <!-- Cart items -->
                    {% for item in cart.items.all %}
                    <div class="d-flex justify-content-between mb-2">
                        <div>
                            <span class="fw-bold">{{ item.vegetable.name }}</span><br>
                            <small class="text-muted">{{ item.quantity }} x {{ item.vegetable.price|floatformat:0 }}đ</small>
                        </div>
                        <span>{{ item.get_cost|floatformat:0 }}đ</span>
                    </div>
                    {% endfor %}
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng số lượng:</span>
                        <span>{{ cart.get_total_items }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính:</span>
                        <span>{{ cart.get_total_price|floatformat:0 }}đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí giao hàng:</span>
                        <span class="text-success">Miễn phí</span>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <strong>Tổng cộng:</strong>
                        <strong class="text-primary">{{ cart.get_total_price|floatformat:0 }}đ</strong>
                    </div>
                </div>
            </div>
            
            <!-- Security info -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6><i class="fas fa-shield-alt text-success"></i> Đảm bảo an toàn</h6>
                    <ul class="list-unstyled small mb-0">
                        <li><i class="fas fa-check text-success"></i> Thông tin được bảo mật</li>
                        <li><i class="fas fa-check text-success"></i> Sản phẩm tươi ngon, chất lượng</li>
                        <li><i class="fas fa-check text-success"></i> Đổi trả trong 24h nếu không hài lòng</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkoutForm = document.getElementById('checkout-form');
    
    checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Basic validation
        const requiredFields = checkoutForm.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                isValid = false;
            } else {
                field.classList.remove('is-invalid');
            }
        });
        
        if (!isValid) {
            showToast('Vui lòng điền đầy đủ thông tin bắt buộc', 'danger');
            return;
        }
        
        // Phone validation
        const phone = document.getElementById('customer_phone').value;
        const phoneRegex = /^[0-9]{10,11}$/;
        if (!phoneRegex.test(phone)) {
            document.getElementById('customer_phone').classList.add('is-invalid');
            showToast('Số điện thoại không hợp lệ', 'danger');
            return;
        }
        
        // Submit form
        this.submit();
    });
    
    // Remove invalid class on input
    const inputs = checkoutForm.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            this.classList.remove('is-invalid');
        });
    });
});
</script>
{% endblock %}